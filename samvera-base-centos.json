{
    "variables": {
        "build_version": "",
        "playbook": "base",
        "project_name": "",
        "project_owner": "",
        "project_version": "",
        "runid": "{{env `PACKER_RUN_UUID`}}",

        "cap_deployment": "",
        "domain": "",
        "geonames_username": "",
        "hostname": "",
        "linux_distro": "",
        "root_db_password": "",
        "ssh_keys_to_add": "",
        "timezone": "",
        "fc_download_war_url": "",


        "rails_host_fqdn": "",
        "solr_fqdn": "",

        "samvera_admin_password": "",
        "samvera_admin_user": "",
        "samvera_db_password": "",
        "samvera_db_user": "",

        "fcdb_password": "",
        "fcdb_user": "",

        "aws_access_key": "",
        "aws_ami_owner": "",
        "aws_bucket": "",
        "aws_region": "",
        "aws_secret_key": "",
        "aws_source_ami": "",

        "az_client_id": "",
        "az_client_secret": "",
        "az_image_offer": "",
        "az_image_publisher": "",
        "az_image_sku": "",
        "az_image_version": "",
        "az_location": "",
        "az_managed_image_rg_name": "",
        "az_subscription_id": "",
        "az_tenant_id": "",

        "vb_cpu_cores": "",
        "vb_memory": "4096",

        "centos_version": "7",
        "vagrant_cloud_token": "",
        "vagrant_cloud_user": "",
        "vagrant_guest_additions_iso_sha256_checksum": "b81d283d9ef88a44e7ac8983422bead0823c825cbfe80417423bd12de91b8046",
        "vagrant_guest_additions_iso": "http://download.virtualbox.org/virtualbox/5.2.12/VBoxGuestAdditions_5.2.12.iso",
        "vagrant_source_iso_sha256_checksum": "38d5d51d9d100fd73df031ffd6bd8b1297ce24660dc8c13a3b8b4534a4bd291c",
        "vagrant_source_iso": "CentOS-7-x86_64-Minimal-1810.iso"
    },
    "builders": [{
            "type": "amazon-ebs",
            "name": "ami",
            "access_key": "{{ user `aws_access_key` }}",
            "secret_key": "{{ user `aws_secret_key` }}",
            "region": "{{ user `aws_region` }}",
            "ssh_keypair_name": "doris-services-keys",
            "ssh_private_key_file": "../ssh/doris-services-keys",
            "source_ami_filter": {
                "filters": {
                    "virtualization-type": "hvm",
                    "name": "{{ user `aws_source_ami` }}",
                    "root-device-type": "ebs"
                },
                "owners": [
                    "{{ user `aws_ami_owner` }}"
                ],
                "most_recent": true
            },
            "force_deregister": true,
            "force_delete_snapshot": true,
            "instance_type": "t2.medium",
            "ssh_username": "centos",
            "ami_name": "{{ user `project_name` }}-{{ user `playbook` }}-{{ user `linux_distro` }} {{ timestamp }}",
            "ami_description": "A {{ user `playbook` }} box for {{ user `project_name` }} ({{ user `linux_distro` }})",
            "launch_block_device_mappings": [{
                "device_name": "/dev/sda1",
                "volume_size": 40,
                "volume_type": "gp2",
                "delete_on_termination": true
            }]
        },
        {
            "type": "azure-arm",
            "name": "arm",

            "client_id": "{{ user `az_client_id` }}",
            "client_secret": "{{ user `az_client_secret` }}",
            "tenant_id": "{{ user `az_tenant_id` }}",
            "subscription_id": "{{ user `az_subscription_id` }}",

            "managed_image_resource_group_name": "{{ user `az_managed_image_rg_name` }}",
            "managed_image_name": "{{ user `project_name` }}-{{ user `playbook` }}-{{ user `linux_distro` }}-{{ timestamp }}",
            "os_type": "Linux",
            "image_publisher": "{{ user `az_image_publisher` }}",
            "image_offer": "{{ user `az_image_offer` }}",
            "image_sku": "{{ user `az_image_sku` }}",
            "location": "{{ user `az_location` }}",
            "vm_size": "Standard_b2s"
        },
        {
            "type": "virtualbox-iso",
            "name": "box",
            "boot_command": [
                "<tab> text ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ks.cfg<enter><wait>"
            ],
            "boot_wait": "10s",
            "disk_size": 81920,
            "guest_os_type": "RedHat_64",
            "headless": true,
            "http_directory": "http",
            "iso_urls": [
                "/ISOs/{{ user `vagrant_source_iso` }}",
                "http://mirrors.mit.edu/centos/{{ user `centos_version` }}/isos/x86_64/{{ user `vagrant_source_iso` }}"
            ],
            "iso_checksum_type": "sha256",
            "iso_checksum": "{{ user `vagrant_source_iso_sha256_checksum` }}",
            "ssh_username": "vagrant",
            "ssh_password": "vagrant",
            "ssh_port": 22,
            "ssh_wait_timeout": "10000s",
            "shutdown_command": "echo 'vagrant' | sudo -S /sbin/halt -h -p",
            "guest_additions_url": "{{ user `vagrant_guest_additions_iso` }}",
            "guest_additions_sha256": "{{ user `vagrant_guest_additions_iso_sha256_checksum` }}",
            "virtualbox_version_file": ".vbox_version",
            "output_directory": "builds/virtualbox/{{ user `runid` }}",
            "vm_name": "{{ user `project_name` }}-{{user `playbook`}}-{{ user `linux_distro` }}",
            "vboxmanage": [
                [
                    "modifyvm",
                    "{{ .Name }}",
                    "--memory",
                    "{{ user `vb_memory` }}"
                ],
                [
                    "modifyvm",
                    "{{ .Name }}",
                    "--cpus",
                    "{{ user `vb_cpu_cores` }}"
                ]
            ]
        }
    ],
    "provisioners": [{
            "type": "shell",
            "only": [
                "ami",
                "arm",
                "box"
            ],
            "execute_command": "echo 'vagrant' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
            "script": "scripts/setup-base.sh"
        },
        {
            "type": "shell",
            "only": [
                "box"
            ],
            "execute_command": "echo 'vagrant' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
            "script": "scripts/setup-vagrant.sh"
        },
        {
            "type": "ansible-local",
            "only": [
                "box"
            ],
            "playbook_file": "ansible/playbooks/samvera-{{user `playbook`}}-centos.yml",
            "galaxy_file": "ansible/requirements/samvera-{{user `playbook`}}-centos.yaml",
            "extra_arguments": [
                "-e \"rails_host_fqdn={{ user `rails_host_fqdn` }}\"",
                "-e \"solr_fqdn={{ user `solr_fqdn` }}\"",
                "-e \"samvera_db_user={{ user `samvera_db_user` }}\"",
                "-e \"samvera_db_password={{ user `samvera_db_password` }}\"",
                "-e \"samvera_admin_user={{ user `samvera_admin_user` }}\"",
                "-e \"samvera_admin_password={{ user `samvera_admin_password` }}\"",
                "-e \"fcdb_user={{ user `fcdb_user` }}",
                "-e \"fcdb_password={{ user `fcdb_password` }}",
                "-e \"fc_admin_user={{ user `fc_admin_user` }}",
                "-e \"fc_admin_password={{ user `fc_admin_password` }}",
                "-e \"fc_download_war_url={{ user `fc_download_war_url` }}",
                "-e \"os_user=vagrant",
                "-e \"os_password=vagrant",
                "-e \"postgres_pass={{ user `root_db_password` }}\"",
                "-e \"timezone={{ user `timezone` }}\"",
                "-e \"hostname={{ user `hostname` }}\"",
                "-e \"domain={{ user `domain` }}\"",
                "-e \"project_owner={{ user `project_owner` }}\"",
                "-e \"project_version={{ user `project_version` }}\"",
                "-e \"project_name={{ user `project_name` }}\"",
                "-e \"ssh_keys_to_add={{ user `ssh_keys_to_add` }}\"",
                "-e \"aws_access_key_id={{ user `aws_access_key` }}\"",
                "-e \"aws_secret_key={{ user `aws_secret_key` }}\"",
                "-e \"aws_bucket={{ user `aws_bucket` }}\""
            ]
        },
        {
            "type": "ansible-local",
            "only": [
                "ami",
                "arm"
            ],
            "playbook_file": "ansible/playbooks/samvera-{{user `playbook`}}-centos.yml",
            "galaxy_file": "ansible/requirements/samvera-{{user `playbook`}}-centos.yaml",
            "extra_arguments": [
                "-e \"rails_host_fqdn={{ user `rails_host_fqdn` }}\"",
                "-e \"solr_fqdn={{ user `solr_fqdn` }}\"",
                "-e \"samvera_db_user={{ user `samvera_db_user` }}\"",
                "-e \"samvera_db_password={{ user `samvera_db_password` }}\"",
                "-e \"samvera_admin_user={{ user `samvera_admin_user` }}\"",
                "-e \"samvera_admin_password={{ user `samvera_admin_password` }}\"",
                "-e \"fcdb_user={{ user `fcdb_user` }}",
                "-e \"fcdb_password={{ user `fcdb_password` }}",
                "-e \"fc_admin_user={{ user `fc_admin_user` }}",
                "-e \"fc_admin_password={{ user `fc_admin_password` }}",
                "-e \"postgres_pass={{ user `root_db_password` }}\"",
                "-e \"timezone={{ user `timezone` }}\"",
                "-e \"hostname={{ user `hostname` }}\"",
                "-e \"domain={{ user `domain` }}\"",
                "-e \"project_owner={{ user `project_owner` }}\"",
                "-e \"project_version={{ user `project_version` }}\"",
                "-e \"project_name={{ user `project_name` }}\"",
                "-e \"ssh_keys_to_add={{ user `ssh_keys_to_add` }}\"",
                "-e \"aws_access_key_id={{ user `aws_access_key` }}\"",
                "-e \"aws_secret_key={{ user `aws_secret_key` }}\"",
                "-e \"aws_bucket={{ user `aws_bucket` }}\""
            ]
        },
        {
            "type": "shell",
            "only": [
                "ami",
                "arm",
                "box"
            ],
            "execute_command": "echo 'vagrant' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
            "script": "scripts/cleanup.sh"
        }
    ],
    "post-processors": [
        [{
                "type": "vagrant",
                "only": [
                    "box"
                ],
                "output": "builds/vagrant/{{ user `project_name` }}-{{ user `playbook` }}-{{ user `linux_distro` }}.box",
                "vagrantfile_template": "vagrant/base/Vagrantfile",
                "keep_input_artifact": true
            },
            {
                "type": "vagrant-cloud",
                "only": [
                    "box"
                ],
                "box_tag": "{{ user `vagrant_cloud_user` }}/{{ user `project_name` }}-{{ user `playbook` }}-{{ user `linux_distro` }}",
                "access_token": "{{ user `vagrant_cloud_token` }}",
                "version": "{{ user `build_version` }}-{{ timestamp }}"
            },
            {
                "type": "shell-local",
                "only": [
                    "box"
                ],
                "inline": [
                    "mv builds/virtualbox/{{ user `runid` }}/* builds/virtualbox/",
                    "rmdir builds/virtualbox/{{ user `runid` }}"
                ]
            }
        ]
    ]
}